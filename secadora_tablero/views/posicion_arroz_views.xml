<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ==================== Kanban (Tablero Principal) ==================== -->
        <record id="view_posicion_arroz_kanban" model="ir.ui.view">
            <field name="name">secadora.posicion.arroz.kanban</field>
            <field name="model">secadora.posicion.arroz</field>
            <field name="arch" type="xml">
                <kanban string="Tablero de Arroz" default_group_by="sitio_id"
                        records_draggable="1" class="o_kanban_small_column">
                    <field name="name"/>
                    <field name="pesaje_name"/>
                    <field name="peso_kg"/>
                    <field name="tercero_id"/>
                    <field name="placa_texto"/>
                    <field name="variedad_id"/>
                    <field name="orden_servicio_id"/>
                    <field name="es_division"/>
                    <field name="fecha_movimiento"/>
                    <field name="state"/>
                    <field name="sitio_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_global_click #{record.state.raw_value == 'retirado' ? 'o_kanban_record_muted' : ''}">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <span t-attf-style="font-size: 1.3em; font-weight: bold; color: #00A09D;">
                                                    <field name="peso_kg" widget="float" digits="[12,2]"/> Kg
                                                </span>
                                            </strong>
                                        </div>
                                        <div>
                                            <t t-if="record.es_division.raw_value">
                                                <span class="badge text-bg-warning ms-1">DIV</span>
                                            </t>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div>
                                            <i class="fa fa-ticket me-1" title="Tiquete"/>
                                            <field name="pesaje_name"/>
                                            <span class="text-muted ms-2">
                                                <field name="name"/>
                                            </span>
                                        </div>
                                        <div>
                                            <i class="fa fa-user me-1" title="Tercero"/>
                                            <field name="tercero_id"/>
                                        </div>
                                        <div t-if="record.placa_texto.raw_value">
                                            <i class="fa fa-truck me-1" title="Placa"/>
                                            <field name="placa_texto"/>
                                        </div>
                                        <div t-if="record.variedad_id.raw_value">
                                            <i class="fa fa-leaf me-1" title="Variedad"/>
                                            <field name="variedad_id"/>
                                        </div>
                                        <div t-if="record.orden_servicio_id.raw_value">
                                            <i class="fa fa-file-text-o me-1" title="Orden de Servicio"/>
                                            <field name="orden_servicio_id"/>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <span class="text-muted" title="Último movimiento">
                                                <i class="fa fa-clock-o"/>
                                                <field name="fecha_movimiento" widget="timeago"/>
                                            </span>
                                        </div>
                                        <div class="oe_kanban_bottom_right">
                                            <button name="action_dividir" type="object"
                                                    class="btn btn-link p-0"
                                                    title="Dividir"
                                                    invisible="state != 'activo'">
                                                <i class="fa fa-code-fork"/>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- ==================== Form ==================== -->
        <record id="view_posicion_arroz_form" model="ir.ui.view">
            <field name="name">secadora.posicion.arroz.form</field>
            <field name="model">secadora.posicion.arroz</field>
            <field name="arch" type="xml">
                <form string="Posición de Arroz">
                    <header>
                        <button name="action_dividir" string="Dividir" type="object"
                                class="oe_highlight" invisible="state != 'activo'"/>
                        <button name="action_retirar" string="Retirar" type="object"
                                class="btn-secondary" invisible="state != 'activo'"
                                confirm="¿Está seguro de retirar esta posición? El arroz se marca como salido de la planta."/>
                        <button name="action_reactivar" string="Reactivar" type="object"
                                class="btn-secondary" invisible="state != 'retirado'"
                                groups="secadora_tablero.group_tablero_admin"/>
                        <field name="state" widget="statusbar"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>
                        <group>
                            <group string="Datos del Pesaje">
                                <field name="pesaje_id" readonly="1"/>
                                <field name="pesaje_name" readonly="1"/>
                                <field name="tercero_id" readonly="1"/>
                                <field name="placa_texto" readonly="1"/>
                                <field name="producto_id" readonly="1"/>
                                <field name="variedad_id" readonly="1"/>
                                <field name="orden_servicio_id" readonly="1"/>
                            </group>
                            <group string="Ubicación y Peso">
                                <field name="sitio_id"/>
                                <field name="peso_kg"/>
                                <field name="peso_original" readonly="1"/>
                                <field name="fecha_ingreso" readonly="1"/>
                                <field name="fecha_movimiento" readonly="1"/>
                            </group>
                        </group>
                        <group>
                            <group>
                                <field name="posicion_origen_id" readonly="1"
                                       invisible="not posicion_origen_id"/>
                                <field name="es_division" invisible="1"/>
                            </group>
                        </group>
                        <group>
                            <field name="notas" placeholder="Notas del operario..."/>
                        </group>
                        <notebook>
                            <page string="Historial de Movimientos" name="movimientos">
                                <field name="movimiento_ids" readonly="1">
                                    <list>
                                        <field name="fecha"/>
                                        <field name="tipo" widget="badge"/>
                                        <field name="sitio_origen_id"/>
                                        <field name="sitio_destino_id"/>
                                        <field name="peso_kg"/>
                                        <field name="usuario_id"/>
                                        <field name="notas"/>
                                    </list>
                                </field>
                            </page>
                            <page string="Posiciones Derivadas" name="hijas"
                                  invisible="not posicion_hija_ids">
                                <field name="posicion_hija_ids" readonly="1">
                                    <list>
                                        <field name="name"/>
                                        <field name="sitio_id"/>
                                        <field name="peso_kg"/>
                                        <field name="state" widget="badge"/>
                                        <field name="fecha_ingreso"/>
                                    </list>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- ==================== List ==================== -->
        <record id="view_posicion_arroz_list" model="ir.ui.view">
            <field name="name">secadora.posicion.arroz.list</field>
            <field name="model">secadora.posicion.arroz</field>
            <field name="arch" type="xml">
                <list string="Posiciones de Arroz"
                      decoration-muted="state == 'retirado'">
                    <field name="name"/>
                    <field name="pesaje_name" string="Tiquete"/>
                    <field name="sitio_id"/>
                    <field name="peso_kg" sum="Total Peso"/>
                    <field name="tercero_id"/>
                    <field name="placa_texto"/>
                    <field name="variedad_id"/>
                    <field name="orden_servicio_id" optional="show"/>
                    <field name="fecha_movimiento"/>
                    <field name="state" widget="badge"
                           decoration-success="state == 'activo'"
                           decoration-muted="state == 'retirado'"/>
                </list>
            </field>
        </record>

        <!-- ==================== Search ==================== -->
        <record id="view_posicion_arroz_search" model="ir.ui.view">
            <field name="name">secadora.posicion.arroz.search</field>
            <field name="model">secadora.posicion.arroz</field>
            <field name="arch" type="xml">
                <search string="Buscar Posiciones">
                    <field name="name"/>
                    <field name="pesaje_name"/>
                    <field name="tercero_id"/>
                    <field name="placa_texto"/>
                    <field name="sitio_id"/>

                    <filter string="Activos" name="filter_activos"
                            domain="[('state', '=', 'activo')]"/>
                    <filter string="Retirados" name="filter_retirados"
                            domain="[('state', '=', 'retirado')]"/>
                    <separator/>
                    <filter string="Divididos" name="filter_divididos"
                            domain="[('es_division', '=', True)]"/>
                    <separator/>
                    <filter string="Hoy" name="filter_hoy"
                            domain="[('fecha_ingreso', '&gt;=', (context_today()).strftime('%Y-%m-%d')),
                                     ('fecha_ingreso', '&lt;', (context_today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>

                    <group expand="0" string="Agrupar por">
                        <filter string="Ubicación" name="group_sitio"
                                context="{'group_by': 'sitio_id'}"/>
                        <filter string="Tercero" name="group_tercero"
                                context="{'group_by': 'tercero_id'}"/>
                        <filter string="Pesaje" name="group_pesaje"
                                context="{'group_by': 'pesaje_id'}"/>
                        <filter string="Estado" name="group_estado"
                                context="{'group_by': 'state'}"/>
                        <filter string="Fecha Ingreso" name="group_fecha"
                                context="{'group_by': 'fecha_ingreso:day'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ==================== Acciones ==================== -->

        <!-- Acción: Tablero Kanban (solo activos) -->
        <record id="action_posicion_arroz_kanban" model="ir.actions.act_window">
            <field name="name">Tablero de Arroz</field>
            <field name="res_model">secadora.posicion.arroz</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="context">{'search_default_filter_activos': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No hay arroz en planta
                </p>
                <p>
                    Las tarjetas se crean automáticamente al completar un pesaje de entrada.
                    Configure sitios contenedores en Calidad &gt; Sitios de Muestra.
                </p>
            </field>
        </record>

        <!-- Acción: Todas las posiciones -->
        <record id="action_posicion_arroz_todas" model="ir.actions.act_window">
            <field name="name">Todas las Posiciones</field>
            <field name="res_model">secadora.posicion.arroz</field>
            <field name="view_mode">list,kanban,form</field>
        </record>

    </data>
</odoo>
